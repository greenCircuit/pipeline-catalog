variables:
  MAKE_RELEASE: "false"  # will be overwritten by semver job
  SEMVER: "0.0.1"


include:
  - pipelines/stages.yaml
  - pipelines/build.yaml
  - pipelines/k8s.yaml
  - pipelines/security.yaml
  - pipelines/template.yml
  - pipelines/release.yaml

# running all pipelines in order to validate them
img:
  extends: .create_image
  parallel:
    matrix:
      - FILE_PATH: ["Dockerfile", "Dockerfile.k8s"]
        REGISTRY_PATH: ["base", "k8s"]

git-leaks:
  extends: .secrets_scan

semver:
  extends: .make-semver

check-semver:
  needs: [semver]
  image: registry.dev.local/homelab/pipeline-catalog:latest
  stage: semver 
  script: | # shell
    env | grep SEMVER
    env | grep MAKE_RELEASE
    if [[ $SEMVER == "" || $MAKE_RELEASE == "" ]]; then
      echo semver job didnt provide env variables
    fi
    echo semver creation job was correct

create-changelog:
  extends: .changelog
  variables:
    version: "${SEMVER}"

tag-repo:
  extends: .create-tag
  variables:
    GIT_TAG: "${SEMVER}"
