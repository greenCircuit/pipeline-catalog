.check-helm:
  stage: unit-test
  image: registry.dev.local/homelab/pipeline-catalog/k8s:latest
  variables:
    CHECK_PATH: ""
  script: | #shell
    echo "CHECK_PATH:        ${CHECK_PATH}"
    echo "inside chart dir"
    ls ${CHECK_PATH}
    cd $CHECK_PATH
    helm template --debug . > generated.yaml
    helm kubeconform --verbose --summary .


    # /kubeconform -summary -output json --skip CustomResourceDefinition generated.yaml > "report.json" || true
    echo "=============="
    cat report.json
    if [[ jq -e '.summary.invalid > 0 or .summary.errors > 0' ]] report.json; then
      echo "ðŸš¨ kubeconform reported invalid resources"
      exit 1
    else
      echo "âœ… kubeconform success"
    fi
  artifacts:
    paths:
      - ${CHECK_PATH}/report.json
      - ${CHECK_PATH}/generated.yam
    expire_in: 1 week
